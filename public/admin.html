<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Leite Certo ‚Äî Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Mono:wght@400;500&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg:      #0a0a0a;
      --surface: #111111;
      --card:    #181818;
      --border:  #2a2a2a;
      --text:    #f0f0f0;
      --muted:   #666666;
      --green:   #22c55e;
      --green-dk:#16a34a;
      --green-lt:rgba(34,197,94,.1);
      --gold:    #f59e0b;
      --gold-lt: rgba(245,158,11,.1);
      --blue:    #3b82f6;
      --blue-lt: rgba(59,130,246,.1);
      --red:     #ef4444;
      --red-lt:  rgba(239,68,68,.1);
      --r:       10px;
    }
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}

    /* LOADING */
    #loading{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;gap:16px;transition:opacity .4s}
    .load-spinner{width:48px;height:48px;border:3px solid var(--border);border-top-color:var(--green);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    #loading p{color:var(--muted);font-size:14px;font-family:'DM Mono',monospace}

    /* AUTH */
    #authScreen{display:none;min-height:100vh;background:var(--bg);align-items:center;justify-content:center;padding:24px;position:relative;overflow:hidden}
    #authScreen::before{content:'ADMIN';position:absolute;font-family:'Syne',sans-serif;font-size:20vw;font-weight:800;color:rgba(255,255,255,.02);top:50%;left:50%;transform:translate(-50%,-50%);white-space:nowrap;pointer-events:none}
    #authScreen.active{display:flex}
    .auth-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:40px 32px;max-width:380px;width:100%;animation:slideUp .4s ease;position:relative;z-index:1}
    .auth-logo{text-align:center;margin-bottom:32px}
    .auth-badge{display:inline-block;background:var(--green-lt);color:var(--green);border:1px solid rgba(34,197,94,.3);border-radius:99px;padding:4px 12px;font-size:11px;font-weight:700;font-family:'DM Mono',monospace;letter-spacing:.1em;margin-bottom:16px}
    .auth-logo h1{font-family:'Syne',sans-serif;font-size:28px;color:var(--text);margin-bottom:4px}
    .auth-logo p{color:var(--muted);font-size:13px}
    .auth-alert{padding:12px 14px;border-radius:var(--r);margin-bottom:16px;font-size:13px;font-weight:600;display:none;font-family:'DM Mono',monospace}
    .auth-alert.show{display:block}
    .auth-alert.error{background:var(--red-lt);color:var(--red);border:1px solid rgba(239,68,68,.3)}
    .auth-alert.success{background:var(--green-lt);color:var(--green);border:1px solid rgba(34,197,94,.3)}

    /* APP */
    #app{display:none;min-height:100vh}
    #app.active{display:flex}

    /* SIDEBAR */
    .sidebar{width:220px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;height:100vh;z-index:100;flex-shrink:0}
    .sidebar-logo{padding:24px 20px;border-bottom:1px solid var(--border)}
    .sidebar-logo .badge{display:inline-block;background:var(--green-lt);color:var(--green);border:1px solid rgba(34,197,94,.3);border-radius:4px;padding:2px 8px;font-size:10px;font-weight:700;font-family:'DM Mono',monospace;letter-spacing:.1em;margin-bottom:8px}
    .sidebar-logo h1{font-family:'Syne',sans-serif;font-size:18px;color:var(--text)}
    .sidebar-logo p{font-size:11px;color:var(--muted);margin-top:2px}
    .sidebar-nav{flex:1;padding:16px 12px;display:flex;flex-direction:column;gap:4px}
    .nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;color:var(--muted);transition:all .2s;border:none;background:none;font-family:inherit;width:100%;text-align:left}
    .nav-item .icon{font-size:16px;width:20px;text-align:center}
    .nav-item:hover{background:var(--card);color:var(--text)}
    .nav-item.active{background:var(--green-lt);color:var(--green)}
    .sidebar-footer{padding:16px;border-top:1px solid var(--border)}
    .admin-info{display:flex;align-items:center;gap:10px;margin-bottom:12px}
    .admin-avatar{width:32px;height:32px;border-radius:8px;background:var(--green-lt);border:1px solid rgba(34,197,94,.3);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:800;color:var(--green);font-family:'Syne',sans-serif}
    .admin-email{font-size:11px;color:var(--muted);font-family:'DM Mono',monospace;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .btn-logout{width:100%;padding:8px;background:var(--red-lt);color:var(--red);border:1px solid rgba(239,68,68,.3);border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .2s}
    .btn-logout:hover{background:rgba(239,68,68,.2)}

    /* MAIN */
    .main{flex:1;margin-left:220px;padding:32px;overflow-y:auto;min-height:100vh}
    .page-header{margin-bottom:28px}
    .page-title{font-family:'Syne',sans-serif;font-size:26px;color:var(--text);margin-bottom:4px}
    .page-sub{font-size:13px;color:var(--muted);font-family:'DM Mono',monospace}

    /* TABS */
    .tab-content{display:none;animation:fadeIn .3s ease}
    .tab-content.active{display:block}

    /* STATS */
    .stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;margin-bottom:24px}
    .stat-box{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:20px 18px;position:relative;overflow:hidden}
    .stat-box::before{content:'';position:absolute;top:0;left:0;width:3px;height:100%}
    .stat-box.green::before{background:var(--green)}
    .stat-box.gold::before{background:var(--gold)}
    .stat-box.blue::before{background:var(--blue)}
    .stat-box.red::before{background:var(--red)}
    .stat-icon{font-size:20px;margin-bottom:10px}
    .stat-val{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;margin-bottom:4px}
    .stat-box.green .stat-val{color:var(--green)}
    .stat-box.gold  .stat-val{color:var(--gold)}
    .stat-box.blue  .stat-val{color:var(--blue)}
    .stat-box.red   .stat-val{color:var(--red)}
    .stat-lbl{font-size:11px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.05em}

    /* TABLE */
    .table-wrap{background:var(--card);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;margin-bottom:24px}
    .table-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px}
    .table-title{font-family:'Syne',sans-serif;font-size:15px;color:var(--text)}
    .table-count{font-size:12px;color:var(--muted);font-family:'DM Mono',monospace}
    .search-bar{padding:8px 12px;background:var(--surface);border:1px solid var(--border);border-radius:8px;font-size:13px;font-family:inherit;color:var(--text);outline:none;min-width:200px;transition:border .2s}
    .search-bar:focus{border-color:var(--green)}
    .search-bar::placeholder{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th{padding:10px 16px;text-align:left;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;border-bottom:1px solid var(--border);background:var(--surface);font-family:'DM Mono',monospace}
    td{padding:12px 16px;font-size:13px;border-bottom:1px solid var(--border);color:var(--text)}
    tr:last-child td{border-bottom:none}
    tr:hover td{background:rgba(255,255,255,.02)}
    .badge{display:inline-block;padding:3px 8px;border-radius:4px;font-size:11px;font-weight:700;font-family:'DM Mono',monospace}
    .badge-green{background:var(--green-lt);color:var(--green)}
    .badge-gold{background:var(--gold-lt);color:var(--gold)}
    .badge-blue{background:var(--blue-lt);color:var(--blue)}
    .badge-red{background:var(--red-lt);color:var(--red)}
    .btn-del{padding:5px 10px;background:var(--red-lt);color:var(--red);border:1px solid rgba(239,68,68,.3);border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .2s}
    .btn-del:hover{background:rgba(239,68,68,.2)}
    .empty-row td{text-align:center;padding:40px;color:var(--muted);font-family:'DM Mono',monospace;font-size:13px}

    /* FORM */
    .form-group{margin-bottom:16px}
    .form-label{display:block;font-size:11px;font-weight:700;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.06em;font-family:'DM Mono',monospace}
    .form-input{width:100%;padding:11px 14px;background:var(--surface);border:1px solid var(--border);border-radius:8px;font-size:14px;font-family:inherit;color:var(--text);outline:none;transition:border .2s}
    .form-input:focus{border-color:var(--green)}
    .btn-primary{padding:11px 20px;background:var(--green);color:#000;border:none;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .2s;width:100%}
    .btn-primary:hover{background:var(--green-dk)}

    /* CHART */
    .chart-wrap{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:20px;margin-bottom:24px}
    .chart-label{font-family:'Syne',sans-serif;font-size:14px;color:var(--text);margin-bottom:16px}
    .bar-row{display:grid;grid-template-columns:80px 1fr 90px;align-items:center;gap:12px;margin-bottom:10px}
    .bar-lbl{font-size:11px;color:var(--muted);text-align:right;font-family:'DM Mono',monospace}
    .bar-track{background:var(--surface);border-radius:3px;height:8px;overflow:hidden}
    .bar-fill{height:100%;border-radius:3px;transition:width .6s ease}
    .bar-green{background:linear-gradient(90deg,var(--green),#16a34a)}
    .bar-gold{background:linear-gradient(90deg,var(--gold),#d97706)}
    .bar-val{font-size:11px;color:var(--text);font-family:'DM Mono',monospace}

    /* MOBILE SIDEBAR */
    .mob-header{display:none;background:var(--surface);border-bottom:1px solid var(--border);padding:14px 20px;position:sticky;top:0;z-index:100;align-items:center;justify-content:space-between}
    .mob-title{font-family:'Syne',sans-serif;font-size:16px;color:var(--text)}
    .mob-menu-btn{background:none;border:none;color:var(--text);font-size:22px;cursor:pointer}
    .sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:99}
    .sidebar-overlay.active{display:block}

    @media(max-width:768px){
      .sidebar{transform:translateX(-100%);transition:transform .3s ease}
      .sidebar.open{transform:translateX(0)}
      .main{margin-left:0;padding:20px}
      .mob-header{display:flex}
      .stats-row{grid-template-columns:1fr 1fr}
      .search-bar{min-width:140px}
      table{font-size:12px}
      th,td{padding:10px 12px}
    }

    /* ANIMATIONS */
    @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    ::-webkit-scrollbar{width:4px;height:4px}
    ::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}

    /* TOAST */
    #toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(16px);background:var(--text);color:var(--bg);padding:10px 20px;border-radius:99px;font-size:13px;font-weight:700;opacity:0;transition:all .3s;z-index:9000;white-space:nowrap;pointer-events:none}
    #toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
  </style>
</head>
<body>

<!-- LOADING -->
<div id="loading">
  <div class="load-spinner"></div>
  <p>verificando acesso...</p>
</div>

<!-- AUTH -->
<div id="authScreen">
  <div class="auth-card">
    <div class="auth-logo">
      <div class="auth-badge">ACESSO RESTRITO</div>
      <h1>üêÑ Leite Certo</h1>
      <p>Painel Administrativo</p>
    </div>
    <div class="auth-alert" id="authAlert"></div>
    <div class="form-group">
      <label class="form-label">E-mail Admin</label>
      <input type="email" id="loginEmail" class="form-input" placeholder="seu@email.com" onkeydown="if(event.key==='Enter')doLogin()"/>
    </div>
    <div class="form-group">
      <label class="form-label">Senha</label>
      <input type="password" id="loginPass" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doLogin()"/>
    </div>
    <button class="btn-primary" onclick="doLogin()">Entrar no painel ‚Üí</button>
  </div>
</div>

<!-- APP -->
<div id="app">
  <!-- MOBILE HEADER -->
  <div class="mob-header">
    <span class="mob-title">üêÑ Admin</span>
    <button class="mob-menu-btn" onclick="toggleSidebar()">‚ò∞</button>
  </div>
  <div class="sidebar-overlay" id="overlay" onclick="toggleSidebar()"></div>

  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <div class="badge">ADMIN PANEL</div>
      <h1>Leite Certo</h1>
      <p>Controle total</p>
    </div>
    <nav class="sidebar-nav">
      <button class="nav-item active" onclick="switchTab('dashboard')">
        <span class="icon">üìä</span> Dashboard
      </button>
      <button class="nav-item" onclick="switchTab('usuarios')">
        <span class="icon">üë•</span> Usu√°rios
      </button>
      <button class="nav-item" onclick="switchTab('registros')">
        <span class="icon">üìã</span> Registros
      </button>
      <button class="nav-item" onclick="switchTab('relatorios')">
        <span class="icon">üìà</span> Relat√≥rios
      </button>
    </nav>
    <div class="sidebar-footer">
      <div class="admin-info">
        <div class="admin-avatar" id="adminAvatar">A</div>
        <div class="admin-email" id="adminEmail">‚Äî</div>
      </div>
      <button class="btn-logout" onclick="doLogout()">‚èè Sair</button>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">

    <!-- DASHBOARD -->
    <div id="tab-dashboard" class="tab-content active">
      <div class="page-header">
        <div class="page-title">Dashboard</div>
        <div class="page-sub">vis√£o geral do sistema</div>
      </div>
      <div class="stats-row" id="dashStats"></div>
      <div class="chart-wrap">
        <div class="chart-label">üìÖ Entregas por m√™s (todos os usu√°rios)</div>
        <div id="dashChart"></div>
      </div>
      <div class="table-wrap">
        <div class="table-header">
          <span class="table-title">üèÜ Top clientes (geral)</span>
        </div>
        <table>
          <thead><tr><th>#</th><th>Cliente</th><th>Litros</th><th>Receita</th><th>Entregas</th></tr></thead>
          <tbody id="topClientes"></tbody>
        </table>
      </div>
    </div>

    <!-- USUARIOS -->
    <div id="tab-usuarios" class="tab-content">
      <div class="page-header">
        <div class="page-title">Usu√°rios</div>
        <div class="page-sub">todos os usu√°rios cadastrados</div>
      </div>
      <div class="table-wrap">
        <div class="table-header">
          <span class="table-title">üë• Usu√°rios cadastrados</span>
          <input class="search-bar" placeholder="üîç Buscar por e-mail‚Ä¶" oninput="filterUsuarios(this.value)"/>
        </div>
        <table>
          <thead><tr><th>E-mail</th><th>Cadastro</th><th>Registros</th><th>Litros</th><th>Receita</th></tr></thead>
          <tbody id="usuariosTable"></tbody>
        </table>
      </div>
    </div>

    <!-- REGISTROS -->
    <div id="tab-registros" class="tab-content">
      <div class="page-header">
        <div class="page-title">Registros</div>
        <div class="page-sub">todos os registros de todos os usu√°rios</div>
      </div>
      <div class="table-wrap">
        <div class="table-header">
          <span class="table-title">üìã Todas as entregas</span>
          <input class="search-bar" placeholder="üîç Buscar por cliente‚Ä¶" oninput="filterRegistros(this.value)"/>
        </div>
        <table>
          <thead><tr><th>Cliente</th><th>Litros</th><th>Pre√ßo/L</th><th>Total</th><th>Data</th><th>A√ß√£o</th></tr></thead>
          <tbody id="registrosTable"></tbody>
        </table>
      </div>
    </div>

    <!-- RELATORIOS -->
    <div id="tab-relatorios" class="tab-content">
      <div class="page-header">
        <div class="page-title">Relat√≥rios</div>
        <div class="page-sub">an√°lise completa do sistema</div>
      </div>
      <div class="stats-row" id="relStats"></div>
      <div class="chart-wrap">
        <div class="chart-label">ü•õ Litros por m√™s</div>
        <div id="relChartL"></div>
      </div>
      <div class="chart-wrap">
        <div class="chart-label">üí∞ Receita por m√™s</div>
        <div id="relChartR"></div>
      </div>
    </div>

  </div>
</div>

<div id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SUPA_URL = 'https://ovpzhrqmhmxmbnfdsnvr.supabase.co';
const SUPA_KEY = 'sb_publishable_cOWazB7fI9BXMVHFEObs4A_vhmtekl0';

const sb = supabase.createClient(SUPA_URL, SUPA_KEY, {
  auth: { autoRefreshToken: true, persistSession: true }
});

let allRecords  = [];
let allProfiles = [];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('load', async () => {
  const { data: { session } } = await sb.auth.getSession();
  hideLoading();
  if (session) {
    const ok = await checkAdmin(session.user);
    if (ok) await startApp(session.user);
    else { await sb.auth.signOut(); showAuth('Voc√™ n√£o tem acesso de administrador.'); }
  } else {
    showAuth();
  }
});

function hideLoading(){
  const l = document.getElementById('loading');
  l.style.opacity = '0';
  setTimeout(() => l.style.display = 'none', 400);
}

async function checkAdmin(user){
  const { data } = await sb.from('admins').select('id').eq('id', user.id).single();
  return !!data;
}

async function startApp(user){
  document.getElementById('authScreen').classList.remove('active');
  document.getElementById('app').classList.add('active');
  document.getElementById('adminAvatar').textContent = (user.email||'A')[0].toUpperCase();
  document.getElementById('adminEmail').textContent  = user.email;
  await loadAllData();
  renderDashboard();
}

function showAuth(err){
  document.getElementById('app').classList.remove('active');
  document.getElementById('authScreen').classList.add('active');
  if (err) { const a=document.getElementById('authAlert'); a.textContent=err; a.className='auth-alert error show'; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function doLogin(){
  const email = document.getElementById('loginEmail').value.trim();
  const pass  = document.getElementById('loginPass').value;
  if (!email||!pass){ showAuthAlert('Preencha e-mail e senha.'); return; }
  const { data, error } = await sb.auth.signInWithPassword({ email, password: pass });
  if (error){ showAuthAlert('E-mail ou senha incorretos.'); return; }
  const ok = await checkAdmin(data.user);
  if (!ok){ await sb.auth.signOut(); showAuthAlert('Voc√™ n√£o tem acesso de administrador.'); return; }
  await startApp(data.user);
}

async function doLogout(){
  if (!confirm('Sair do painel?')) return;
  await sb.auth.signOut();
  showAuth();
}

function showAuthAlert(msg){
  const a = document.getElementById('authAlert');
  a.textContent = msg; a.className = 'auth-alert error show';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadAllData(){
  const [{ data: recs }, { data: profiles }] = await Promise.all([
    sb.from('entregas').select('*').order('date', { ascending: false }),
    sb.from('profiles').select('*').order('created_at', { ascending: false })
  ]);
  allRecords  = recs  || [];
  allProfiles = profiles || [];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(name){
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
  document.getElementById(`tab-${name}`).classList.add('active');
  document.querySelectorAll('.nav-item')[['dashboard','usuarios','registros','relatorios'].indexOf(name)].classList.add('active');
  if (name === 'dashboard')  renderDashboard();
  if (name === 'usuarios')   renderUsuarios();
  if (name === 'registros')  renderRegistros();
  if (name === 'relatorios') renderRelatorios();
  if (window.innerWidth <= 768) toggleSidebar(false);
}

function toggleSidebar(force){
  const s = document.getElementById('sidebar');
  const o = document.getElementById('overlay');
  const open = force !== undefined ? force : !s.classList.contains('open');
  s.classList.toggle('open', open);
  o.classList.toggle('active', open);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDashboard(){
  const tL   = allRecords.reduce((s,r)=>s+r.quantity,0);
  const tR   = allRecords.reduce((s,r)=>s+r.quantity*(r.price||0),0);
  const cnt  = allRecords.length;
  const users= allProfiles.length;

  document.getElementById('dashStats').innerHTML = `
    <div class="stat-box green"><div class="stat-icon">ü•õ</div><div class="stat-val">${fL(tL)}</div><div class="stat-lbl">Total de litros</div></div>
    <div class="stat-box gold"><div class="stat-icon">üí∞</div><div class="stat-val">${fR(tR)}</div><div class="stat-lbl">Receita total</div></div>
    <div class="stat-box blue"><div class="stat-icon">üì¶</div><div class="stat-val">${cnt}</div><div class="stat-lbl">Total de entregas</div></div>
    <div class="stat-box red"><div class="stat-icon">üë•</div><div class="stat-val">${users}</div><div class="stat-lbl">Usu√°rios</div></div>
  `;

  // Chart by month
  const months = getLast12Months();
  const maxL   = Math.max(...months.map(m=>m.liters), 1);
  document.getElementById('dashChart').innerHTML = months.map(m => `
    <div class="bar-row">
      <span class="bar-lbl">${m.label}</span>
      <div class="bar-track"><div class="bar-fill bar-green" style="width:${(m.liters/maxL*100).toFixed(1)}%"></div></div>
      <span class="bar-val">${fL(m.liters)}</span>
    </div>`).join('');

  // Top clientes
  const byP = {};
  allRecords.forEach(r=>{ if(!byP[r.person]) byP[r.person]={liters:0,money:0,count:0}; byP[r.person].liters+=r.quantity; byP[r.person].money+=r.quantity*(r.price||0); byP[r.person].count+=1; });
  const ranking = Object.entries(byP).sort((a,b)=>b[1].liters-a[1].liters).slice(0,10);
  document.getElementById('topClientes').innerHTML = ranking.length === 0
    ? '<tr class="empty-row"><td colspan="5">Nenhum dado</td></tr>'
    : ranking.map(([name,s],i) => `
        <tr>
          <td>${['ü•á','ü•à','ü•â'][i]||`#${i+1}`}</td>
          <td>${esc(name)}</td>
          <td><span class="badge badge-green">${fL(s.liters)}</span></td>
          <td><span class="badge badge-gold">${fR(s.money)}</span></td>
          <td>${s.count}</td>
        </tr>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// USUARIOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderUsuarios(filter=''){
  const profiles = allProfiles.filter(p => !filter || (p.email||'').toLowerCase().includes(filter.toLowerCase()));
  document.getElementById('usuariosTable').innerHTML = profiles.length === 0
    ? '<tr class="empty-row"><td colspan="5">Nenhum usu√°rio encontrado</td></tr>'
    : profiles.map(p => {
        const recs  = allRecords.filter(r => r.user_id === p.id);
        const liters = recs.reduce((s,r)=>s+r.quantity,0);
        const money  = recs.reduce((s,r)=>s+r.quantity*(r.price||0),0);
        return `<tr>
          <td style="font-family:'DM Mono',monospace;font-size:12px">${esc(p.email||'‚Äî')}</td>
          <td style="font-family:'DM Mono',monospace;font-size:12px;color:var(--muted)">${fDate(p.created_at?.split('T')[0])}</td>
          <td><span class="badge badge-blue">${recs.length}</span></td>
          <td><span class="badge badge-green">${fL(liters)}</span></td>
          <td><span class="badge badge-gold">${fR(money)}</span></td>
        </tr>`;
      }).join('');
}

function filterUsuarios(v){ renderUsuarios(v); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REGISTROS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderRegistros(filter=''){
  const recs = allRecords.filter(r => !filter || r.person.toLowerCase().includes(filter.toLowerCase()));
  document.getElementById('registrosTable').innerHTML = recs.length === 0
    ? '<tr class="empty-row"><td colspan="6">Nenhum registro encontrado</td></tr>'
    : recs.map(r => `
        <tr>
          <td style="font-weight:700">${esc(r.person)}</td>
          <td><span class="badge badge-green">${fL(r.quantity)}</span></td>
          <td style="font-family:'DM Mono',monospace;font-size:12px;color:var(--muted)">${r.price > 0 ? fR(r.price) : '‚Äî'}</td>
          <td><span class="badge badge-gold">${r.price > 0 ? fR(r.quantity*r.price) : '‚Äî'}</span></td>
          <td style="font-family:'DM Mono',monospace;font-size:12px;color:var(--muted)">${fDate(r.date)}</td>
          <td><button class="btn-del" onclick="deleteRecord('${r.id}')">üóë Apagar</button></td>
        </tr>`).join('');
}

function filterRegistros(v){ renderRegistros(v); }

async function deleteRecord(id){
  if (!confirm('Apagar este registro?')) return;
  const { error } = await sb.from('entregas').delete().eq('id', id);
  if (error){ toast('‚ö†Ô∏è Erro ao apagar'); return; }
  allRecords = allRecords.filter(r => r.id !== id);
  renderRegistros();
  renderDashboard();
  toast('Registro apagado ‚úì');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RELATORIOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderRelatorios(){
  const tL   = allRecords.reduce((s,r)=>s+r.quantity,0);
  const tR   = allRecords.reduce((s,r)=>s+r.quantity*(r.price||0),0);
  const cnt  = allRecords.length;
  const avg  = cnt ? tL/cnt : 0;

  document.getElementById('relStats').innerHTML = `
    <div class="stat-box green"><div class="stat-icon">ü•õ</div><div class="stat-val">${fL(tL)}</div><div class="stat-lbl">Total litros</div></div>
    <div class="stat-box gold"><div class="stat-icon">üí∞</div><div class="stat-val">${fR(tR)}</div><div class="stat-lbl">Receita total</div></div>
    <div class="stat-box blue"><div class="stat-icon">üì¶</div><div class="stat-val">${cnt}</div><div class="stat-lbl">Entregas</div></div>
    <div class="stat-box red"><div class="stat-icon">üìà</div><div class="stat-val">${fL(avg)}</div><div class="stat-lbl">M√©dia/entrega</div></div>
  `;

  const months = getLast12Months();
  const maxL   = Math.max(...months.map(m=>m.liters),1);
  const maxR   = Math.max(...months.map(m=>m.money),1);

  document.getElementById('relChartL').innerHTML = months.map(m=>`
    <div class="bar-row">
      <span class="bar-lbl">${m.label}</span>
      <div class="bar-track"><div class="bar-fill bar-green" style="width:${(m.liters/maxL*100).toFixed(1)}%"></div></div>
      <span class="bar-val">${fL(m.liters)}</span>
    </div>`).join('');

  document.getElementById('relChartR').innerHTML = months.map(m=>`
    <div class="bar-row">
      <span class="bar-lbl">${m.label}</span>
      <div class="bar-track"><div class="bar-fill bar-gold" style="width:${(m.money/maxR*100).toFixed(1)}%"></div></div>
      <span class="bar-val">${fR(m.money)}</span>
    </div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const fL    = n  => n.toLocaleString('pt-BR',{minimumFractionDigits:1,maximumFractionDigits:1})+' L';
const fR    = n  => 'R$ '+n.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
const esc   = t  => { const d=document.createElement('div'); d.textContent=t; return d.innerHTML; };
const fDate = s  => { if(!s) return '‚Äî'; return new Date(s+'T00:00:00').toLocaleDateString('pt-BR'); };

function getLast12Months(){
  const mNames = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
  const result = [];
  for (let i=11; i>=0; i--){
    const d = new Date();
    d.setMonth(d.getMonth()-i);
    const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    const recs = allRecords.filter(r => r.date.startsWith(ym));
    result.push({
      label:  mNames[d.getMonth()],
      liters: recs.reduce((s,r)=>s+r.quantity,0),
      money:  recs.reduce((s,r)=>s+r.quantity*(r.price||0),0)
    });
  }
  return result;
}

function toast(msg){
  const el = document.getElementById('toast');
  el.textContent = msg; el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2800);
}
</script>
</body>
</html>
