<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
  <title>Leite Certo ‚Äî Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Mono:wght@400;500&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg:      #0a0a0a;
      --surface: #111111;
      --card:    #181818;
      --border:  #2a2a2a;
      --text:    #f0f0f0;
      --muted:   #666666;
      --green:   #22c55e;
      --green-dk:#16a34a;
      --green-lt:rgba(34,197,94,.12);
      --gold:    #f59e0b;
      --gold-lt: rgba(245,158,11,.12);
      --blue:    #3b82f6;
      --blue-lt: rgba(59,130,246,.12);
      --red:     #ef4444;
      --red-lt:  rgba(239,68,68,.12);
      --r:       10px;
    }
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
    #loading{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;gap:16px;transition:opacity .4s}
    .spinner{width:44px;height:44px;border:3px solid var(--border);border-top-color:var(--green);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    #loading p{color:var(--muted);font-size:13px;font-family:'DM Mono',monospace}
    #authScreen{display:none;min-height:100vh;background:var(--bg);align-items:center;justify-content:center;padding:24px}
    #authScreen.active{display:flex}
    .auth-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:36px 28px;max-width:380px;width:100%;animation:slideUp .4s ease}
    .auth-logo{text-align:center;margin-bottom:28px}
    .auth-badge{display:inline-block;background:var(--green-lt);color:var(--green);border:1px solid rgba(34,197,94,.3);border-radius:99px;padding:4px 12px;font-size:11px;font-weight:700;font-family:'DM Mono',monospace;letter-spacing:.1em;margin-bottom:12px}
    .auth-logo h1{font-family:'Syne',sans-serif;font-size:26px;margin-bottom:4px}
    .auth-logo p{color:var(--muted);font-size:13px}
    .auth-alert{padding:12px 14px;border-radius:var(--r);margin-bottom:16px;font-size:13px;font-weight:600;display:none}
    .auth-alert.show{display:block}
    .auth-alert.error{background:var(--red-lt);color:var(--red);border:1px solid rgba(239,68,68,.3)}
    #app{display:none;min-height:100vh;flex-direction:column}
    #app.active{display:flex}
    .app-header{background:var(--surface);border-bottom:1px solid var(--border);padding:14px 16px;position:sticky;top:0;z-index:100;display:flex;align-items:center;justify-content:space-between}
    .header-left{display:flex;align-items:center;gap:10px}
    .header-badge{background:var(--green-lt);color:var(--green);border:1px solid rgba(34,197,94,.3);border-radius:4px;padding:2px 8px;font-size:10px;font-weight:700;font-family:'DM Mono',monospace;letter-spacing:.08em}
    .header-title{font-family:'Syne',sans-serif;font-size:17px}
    .btn-logout-top{background:var(--red-lt);color:var(--red);border:1px solid rgba(239,68,68,.3);border-radius:8px;padding:7px 12px;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit}
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--surface);border-top:1px solid var(--border);display:flex;z-index:100;padding-bottom:env(safe-area-inset-bottom)}
    .bnav-btn{flex:1;padding:10px 4px 12px;border:none;background:none;color:var(--muted);cursor:pointer;font-size:10px;font-weight:700;font-family:inherit;display:flex;flex-direction:column;align-items:center;gap:3px;transition:all .2s;border-top:2px solid transparent}
    .bnav-btn .bicon{font-size:20px}
    .bnav-btn.active{color:var(--green);border-top-color:var(--green)}
    .main{flex:1;padding:16px;padding-bottom:84px;overflow-y:auto}
    .page-hdr{margin-bottom:18px}
    .page-title{font-family:'Syne',sans-serif;font-size:22px;margin-bottom:2px}
    .page-sub{font-size:12px;color:var(--muted);font-family:'DM Mono',monospace}
    .tab-content{display:none;animation:fadeIn .3s ease}
    .tab-content.active{display:block}
    .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
    .stat-box{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:16px 14px;position:relative;overflow:hidden}
    .stat-box::before{content:'';position:absolute;top:0;left:0;width:100%;height:3px}
    .stat-box.green::before{background:var(--green)}
    .stat-box.gold::before{background:var(--gold)}
    .stat-box.blue::before{background:var(--blue)}
    .stat-box.red::before{background:var(--red)}
    .stat-icon{font-size:18px;margin-bottom:8px}
    .stat-val{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;margin-bottom:3px;line-height:1.2}
    .stat-box.green .stat-val{color:var(--green)}
    .stat-box.gold  .stat-val{color:var(--gold)}
    .stat-box.blue  .stat-val{color:var(--blue)}
    .stat-box.red   .stat-val{color:var(--red)}
    .stat-lbl{font-size:10px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.04em}
    .section-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;margin-bottom:14px}
    .section-hdr{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px}
    .section-title{font-family:'Syne',sans-serif;font-size:14px}
    .section-count{font-size:11px;color:var(--muted);font-family:'DM Mono',monospace}
    .search-input{width:100%;padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:8px;font-size:14px;font-family:inherit;color:var(--text);outline:none;margin-bottom:12px;transition:border .2s}
    .search-input:focus{border-color:var(--green)}
    .search-input::placeholder{color:var(--muted)}
    .rec-card{padding:14px 16px;border-bottom:1px solid var(--border)}
    .rec-card:last-child{border-bottom:none}
    .rec-name{font-size:15px;font-weight:700;margin-bottom:6px}
    .rec-meta{display:flex;gap:8px;flex-wrap:wrap;font-size:12px;align-items:center}
    .rec-actions{margin-top:8px}
    .user-card{padding:14px 16px;border-bottom:1px solid var(--border)}
    .user-card:last-child{border-bottom:none}
    .user-email{font-size:13px;font-weight:700;color:var(--text);margin-bottom:6px;font-family:'DM Mono',monospace;word-break:break-all}
    .user-meta{display:flex;gap:8px;flex-wrap:wrap}
    .user-date{font-size:11px;color:var(--muted);margin-top:4px}
    .badge{display:inline-block;padding:3px 8px;border-radius:4px;font-size:11px;font-weight:700;font-family:'DM Mono',monospace}
    .badge-green{background:var(--green-lt);color:var(--green)}
    .badge-gold{background:var(--gold-lt);color:var(--gold)}
    .badge-blue{background:var(--blue-lt);color:var(--blue)}
    .btn-del{padding:6px 12px;background:var(--red-lt);color:var(--red);border:1px solid rgba(239,68,68,.3);border-radius:6px;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit}
    .btn-primary{padding:12px;background:var(--green);color:#000;border:none;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;width:100%}
    .form-group{margin-bottom:16px}
    .form-label{display:block;font-size:11px;font-weight:700;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.06em;font-family:'DM Mono',monospace}
    .form-input{width:100%;padding:12px 14px;background:var(--surface);border:1px solid var(--border);border-radius:8px;font-size:15px;font-family:inherit;color:var(--text);outline:none;transition:border .2s}
    .form-input:focus{border-color:var(--green)}
    .chart-wrap{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:16px;margin-bottom:14px}
    .chart-lbl{font-family:'Syne',sans-serif;font-size:13px;margin-bottom:14px}
    .bar-row{display:grid;grid-template-columns:36px 1fr 68px;align-items:center;gap:8px;margin-bottom:9px}
    .bar-label{font-size:10px;color:var(--muted);text-align:right;font-family:'DM Mono',monospace}
    .bar-track{background:var(--surface);border-radius:3px;height:8px;overflow:hidden}
    .bar-fill{height:100%;border-radius:3px;transition:width .6s ease}
    .bar-green{background:linear-gradient(90deg,var(--green),#16a34a)}
    .bar-gold{background:linear-gradient(90deg,var(--gold),#d97706)}
    .bar-value{font-size:10px;color:var(--text);font-family:'DM Mono',monospace}
    .rank-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid var(--border)}
    .rank-item:last-child{border-bottom:none}
    .rank-pos{font-size:20px;min-width:28px;text-align:center}
    .rank-name{font-weight:700;font-size:14px;flex:1}
    .rank-info{font-size:11px;color:var(--muted);margin-top:2px}
    .empty{padding:40px 20px;text-align:center;color:var(--muted);font-family:'DM Mono',monospace;font-size:13px}
    #toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(16px);background:var(--text);color:var(--bg);padding:10px 20px;border-radius:99px;font-size:13px;font-weight:700;opacity:0;transition:all .3s;z-index:9000;white-space:nowrap;pointer-events:none}
    #toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
    @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    ::-webkit-scrollbar{width:4px}
    ::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
  </style>
</head>
<body>

<div id="loading">
  <div class="spinner"></div>
  <p>verificando acesso...</p>
</div>

<div id="authScreen">
  <div class="auth-card">
    <div class="auth-logo">
      <div class="auth-badge">ACESSO RESTRITO</div>
      <h1>üêÑ Leite Certo</h1>
      <p>Painel Administrativo</p>
    </div>
    <div class="auth-alert" id="authAlert"></div>
    <div class="form-group">
      <label class="form-label">E-mail Admin</label>
      <input type="email" id="loginEmail" class="form-input" placeholder="seu@email.com" onkeydown="if(event.key==='Enter')doLogin()"/>
    </div>
    <div class="form-group">
      <label class="form-label">Senha</label>
      <input type="password" id="loginPass" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doLogin()"/>
    </div>
    <button class="btn-primary" onclick="doLogin()">Entrar no painel ‚Üí</button>
  </div>
</div>

<div id="app">
  <div class="app-header">
    <div class="header-left">
      <span class="header-badge">ADMIN</span>
      <span class="header-title">üêÑ Leite Certo</span>
    </div>
    <button class="btn-logout-top" onclick="doLogout()">‚èè Sair</button>
  </div>

  <div class="main">
    <div id="tab-dashboard" class="tab-content active">
      <div class="page-hdr">
        <div class="page-title">Dashboard</div>
        <div class="page-sub">vis√£o geral do sistema</div>
      </div>
      <div class="stats-grid" id="dashStats"></div>
      <div class="chart-wrap">
        <div class="chart-lbl">üìÖ Entregas por m√™s</div>
        <div id="dashChart"></div>
      </div>
      <div class="section-card">
        <div class="section-hdr"><span class="section-title">üèÜ Top clientes</span></div>
        <div id="topClientes"></div>
      </div>
    </div>

    <div id="tab-usuarios" class="tab-content">
      <div class="page-hdr">
        <div class="page-title">Usu√°rios</div>
        <div class="page-sub">todos os cadastrados</div>
      </div>
      <input class="search-input" placeholder="üîç Buscar por e-mail‚Ä¶" oninput="filterUsuarios(this.value)"/>
      <div class="section-card">
        <div class="section-hdr">
          <span class="section-title">üë• Usu√°rios</span>
          <span class="section-count" id="usuariosCount"></span>
        </div>
        <div id="usuariosList"></div>
      </div>
    </div>

    <div id="tab-registros" class="tab-content">
      <div class="page-hdr">
        <div class="page-title">Registros</div>
        <div class="page-sub">todas as entregas</div>
      </div>
      <input class="search-input" placeholder="üîç Buscar por cliente‚Ä¶" oninput="filterRegistros(this.value)"/>
      <div class="section-card">
        <div class="section-hdr">
          <span class="section-title">üìã Entregas</span>
          <span class="section-count" id="registrosCount"></span>
        </div>
        <div id="registrosList"></div>
      </div>
    </div>

    <div id="tab-relatorios" class="tab-content">
      <div class="page-hdr">
        <div class="page-title">Relat√≥rios</div>
        <div class="page-sub">an√°lise completa</div>
      </div>
      <div class="stats-grid" id="relStats"></div>
      <div class="chart-wrap">
        <div class="chart-lbl">ü•õ Litros por m√™s</div>
        <div id="relChartL"></div>
      </div>
      <div class="chart-wrap">
        <div class="chart-lbl">üí∞ Receita por m√™s</div>
        <div id="relChartR"></div>
      </div>
    </div>
  </div>

  <div class="bottom-nav">
    <button class="bnav-btn active" onclick="switchTab('dashboard')"><span class="bicon">üìä</span>Dashboard</button>
    <button class="bnav-btn" onclick="switchTab('usuarios')"><span class="bicon">üë•</span>Usu√°rios</button>
    <button class="bnav-btn" onclick="switchTab('registros')"><span class="bicon">üìã</span>Registros</button>
    <button class="bnav-btn" onclick="switchTab('relatorios')"><span class="bicon">üìà</span>Relat√≥rios</button>
  </div>
</div>

<div id="toast"></div>

<script>
const SUPA_URL = 'https://ovpzhrqmhmxmbnfdsnvr.supabase.co';
const SUPA_KEY = 'sb_publishable_cOWazB7fI9BXMVHFEObs4A_vhmtekl0';
const sb = supabase.createClient(SUPA_URL, SUPA_KEY, { auth:{ autoRefreshToken:true, persistSession:true } });

let allRecords=[], allProfiles=[];

window.addEventListener('load', async () => {
  const { data:{ session } } = await sb.auth.getSession();
  hideLoading();
  if (session) {
    const ok = await checkAdmin(session.user);
    if (ok) await startApp(session.user);
    else { await sb.auth.signOut(); showAuth('Voc√™ n√£o tem acesso de administrador.'); }
  } else { showAuth(); }
});

function hideLoading(){ const l=document.getElementById('loading'); l.style.opacity='0'; setTimeout(()=>l.style.display='none',400); }

async function checkAdmin(user){
  const { data } = await sb.from('admins').select('id').eq('id',user.id).single();
  return !!data;
}

async function startApp(user){
  document.getElementById('authScreen').classList.remove('active');
  document.getElementById('app').classList.add('active');
  await loadAllData();
  renderDashboard();
}

function showAuth(err){
  document.getElementById('app').classList.remove('active');
  document.getElementById('authScreen').classList.add('active');
  if (err){ const a=document.getElementById('authAlert'); a.textContent=err; a.className='auth-alert error show'; }
}

async function doLogin(){
  const email=document.getElementById('loginEmail').value.trim();
  const pass=document.getElementById('loginPass').value;
  if (!email||!pass){ showAuthAlert('Preencha e-mail e senha.'); return; }
  const { data, error } = await sb.auth.signInWithPassword({ email, password:pass });
  if (error){ showAuthAlert('E-mail ou senha incorretos.'); return; }
  const ok = await checkAdmin(data.user);
  if (!ok){ await sb.auth.signOut(); showAuthAlert('Voc√™ n√£o tem acesso de administrador.'); return; }
  await startApp(data.user);
}

async function doLogout(){
  if (!confirm('Sair do painel?')) return;
  await sb.auth.signOut(); showAuth();
}

function showAuthAlert(msg){ const a=document.getElementById('authAlert'); a.textContent=msg; a.className='auth-alert error show'; }

async function loadAllData(){
  const [{ data:recs },{ data:profiles }] = await Promise.all([
    sb.from('entregas').select('*').order('date',{ascending:false}),
    sb.from('profiles').select('*').order('created_at',{ascending:false})
  ]);
  allRecords=recs||[]; allProfiles=profiles||[];
}

function switchTab(name){
  document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));
  document.querySelectorAll('.bnav-btn').forEach(el=>el.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  document.querySelectorAll('.bnav-btn')[['dashboard','usuarios','registros','relatorios'].indexOf(name)].classList.add('active');
  if(name==='dashboard') renderDashboard();
  if(name==='usuarios')  renderUsuarios();
  if(name==='registros') renderRegistros();
  if(name==='relatorios') renderRelatorios();
}

function renderDashboard(){
  const tL=allRecords.reduce((s,r)=>s+r.quantity,0);
  const tR=allRecords.reduce((s,r)=>s+r.quantity*(r.price||0),0);
  const cnt=allRecords.length, users=allProfiles.length;
  document.getElementById('dashStats').innerHTML=`
    <div class="stat-box green"><div class="stat-icon">ü•õ</div><div class="stat-val">${fL(tL)}</div><div class="stat-lbl">Total litros</div></div>
    <div class="stat-box gold"><div class="stat-icon">üí∞</div><div class="stat-val">${fR(tR)}</div><div class="stat-lbl">Receita total</div></div>
    <div class="stat-box blue"><div class="stat-icon">üì¶</div><div class="stat-val">${cnt}</div><div class="stat-lbl">Entregas</div></div>
    <div class="stat-box red"><div class="stat-icon">üë•</div><div class="stat-val">${users}</div><div class="stat-lbl">Usu√°rios</div></div>`;
  const months=getLast12Months(), maxL=Math.max(...months.map(m=>m.liters),1);
  document.getElementById('dashChart').innerHTML=months.map(m=>`
    <div class="bar-row"><span class="bar-label">${m.label}</span>
    <div class="bar-track"><div class="bar-fill bar-green" style="width:${(m.liters/maxL*100).toFixed(1)}%"></div></div>
    <span class="bar-value">${fL(m.liters)}</span></div>`).join('');
  const byP={};
  allRecords.forEach(r=>{ if(!byP[r.person]) byP[r.person]={liters:0,money:0,count:0}; byP[r.person].liters+=r.quantity; byP[r.person].money+=r.quantity*(r.price||0); byP[r.person].count+=1; });
  const ranking=Object.entries(byP).sort((a,b)=>b[1].liters-a[1].liters).slice(0,10);
  document.getElementById('topClientes').innerHTML=ranking.length===0?'<div class="empty">Nenhum dado ainda</div>':ranking.map(([name,s],i)=>`
    <div class="rank-item"><span class="rank-pos">${['ü•á','ü•à','ü•â'][i]||'#'+(i+1)}</span>
    <div><div class="rank-name">${esc(name)}</div><div class="rank-info">${s.count} entrega${s.count!==1?'s':''}</div></div>
    <div style="text-align:right"><span class="badge badge-green">${fL(s.liters)}</span>${s.money>0?'<br><span class="badge badge-gold" style="margin-top:4px">'+fR(s.money)+'</span>':''}</div></div>`).join('');
}

function renderUsuarios(filter=''){
  const list=allProfiles.filter(p=>!filter||(p.email||'').toLowerCase().includes(filter.toLowerCase()));
  document.getElementById('usuariosCount').textContent=list.length+' usu√°rio'+(list.length!==1?'s':'');
  document.getElementById('usuariosList').innerHTML=list.length===0?'<div class="empty">Nenhum encontrado</div>':list.map(p=>{
    const recs=allRecords.filter(r=>r.user_id===p.id);
    const liters=recs.reduce((s,r)=>s+r.quantity,0), money=recs.reduce((s,r)=>s+r.quantity*(r.price||0),0);
    return `<div class="user-card"><div class="user-email">${esc(p.email||'‚Äî')}</div>
    <div class="user-meta"><span class="badge badge-blue">üì¶ ${recs.length}</span><span class="badge badge-green">ü•õ ${fL(liters)}</span>${money>0?'<span class="badge badge-gold">üí∞ '+fR(money)+'</span>':''}</div>
    <div class="user-date">Cadastro: ${fDate(p.created_at?.split('T')[0])}</div></div>`;
  }).join('');
}
function filterUsuarios(v){ renderUsuarios(v); }

function renderRegistros(filter=''){
  const list=allRecords.filter(r=>!filter||r.person.toLowerCase().includes(filter.toLowerCase()));
  document.getElementById('registrosCount').textContent=list.length+' registro'+(list.length!==1?'s':'');
  document.getElementById('registrosList').innerHTML=list.length===0?'<div class="empty">Nenhum encontrado</div>':list.map(r=>`
    <div class="rec-card"><div class="rec-name">${esc(r.person)}</div>
    <div class="rec-meta"><span class="badge badge-green">ü•õ ${fL(r.quantity)}</span>${r.price>0?'<span class="badge badge-gold">üí∞ '+fR(r.quantity*r.price)+'</span>':''}
    <span style="color:var(--muted);font-size:11px;font-family:'DM Mono',monospace">üìÖ ${fDate(r.date)}</span></div>
    <div class="rec-actions"><button class="btn-del" onclick="deleteRecord('${r.id}')">üóë Apagar</button></div></div>`).join('');
}
function filterRegistros(v){ renderRegistros(v); }

async function deleteRecord(id){
  if(!confirm('Apagar este registro?')) return;
  const { error }=await sb.from('entregas').delete().eq('id',id);
  if(error){ toast('‚ö†Ô∏è Erro ao apagar'); return; }
  allRecords=allRecords.filter(r=>r.id!==id);
  renderRegistros(); renderDashboard();
  toast('Registro apagado ‚úì');
}

function renderRelatorios(){
  const tL=allRecords.reduce((s,r)=>s+r.quantity,0), tR=allRecords.reduce((s,r)=>s+r.quantity*(r.price||0),0);
  const cnt=allRecords.length, avg=cnt?tL/cnt:0;
  document.getElementById('relStats').innerHTML=`
    <div class="stat-box green"><div class="stat-icon">ü•õ</div><div class="stat-val">${fL(tL)}</div><div class="stat-lbl">Total litros</div></div>
    <div class="stat-box gold"><div class="stat-icon">üí∞</div><div class="stat-val">${fR(tR)}</div><div class="stat-lbl">Receita total</div></div>
    <div class="stat-box blue"><div class="stat-icon">üì¶</div><div class="stat-val">${cnt}</div><div class="stat-lbl">Entregas</div></div>
    <div class="stat-box red"><div class="stat-icon">üìà</div><div class="stat-val">${fL(avg)}</div><div class="stat-lbl">M√©dia/entrega</div></div>`;
  const months=getLast12Months();
  const maxL=Math.max(...months.map(m=>m.liters),1), maxR=Math.max(...months.map(m=>m.money),1);
  document.getElementById('relChartL').innerHTML=months.map(m=>`
    <div class="bar-row"><span class="bar-label">${m.label}</span>
    <div class="bar-track"><div class="bar-fill bar-green" style="width:${(m.liters/maxL*100).toFixed(1)}%"></div></div>
    <span class="bar-value">${fL(m.liters)}</span></div>`).join('');
  document.getElementById('relChartR').innerHTML=months.map(m=>`
    <div class="bar-row"><span class="bar-label">${m.label}</span>
    <div class="bar-track"><div class="bar-fill bar-gold" style="width:${(m.money/maxR*100).toFixed(1)}%"></div></div>
    <span class="bar-value">${fR(m.money)}</span></div>`).join('');
}

const fL=n=>n.toLocaleString('pt-BR',{minimumFractionDigits:1,maximumFractionDigits:1})+' L';
const fR=n=>'R$ '+n.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
const esc=t=>{ const d=document.createElement('div'); d.textContent=t; return d.innerHTML; };
const fDate=s=>{ if(!s) return '‚Äî'; return new Date(s+'T00:00:00').toLocaleDateString('pt-BR'); };

function getLast12Months(){
  const mn=['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'], r=[];
  for(let i=11;i>=0;i--){
    const d=new Date(); d.setMonth(d.getMonth()-i);
    const ym=d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
    const recs=allRecords.filter(r=>r.date.startsWith(ym));
    r.push({ label:mn[d.getMonth()], liters:recs.reduce((s,r)=>s+r.quantity,0), money:recs.reduce((s,r)=>s+r.quantity*(r.price||0),0) });
  }
  return r;
}

function toast(msg){ const el=document.getElementById('toast'); el.textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),2800); }
</script>
</body>
</html>
