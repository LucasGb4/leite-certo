<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <!-- CSP removed for Firebase compatibility -->
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
  <title>Leite Certo üêÑ</title>
  <meta name="theme-color" content="#14532d"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="apple-mobile-web-app-title" content="Leite Certo"/>
  <link rel="manifest" href="manifest.json"/>
  <link rel="apple-touch-icon" href="icons/icon-192.png"/>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet"/>
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
  import { getFirestore, collection, doc, addDoc, getDocs, updateDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC3V00Qj405tjwCt7Ec9JSYVQ6-otl06XE",
    authDomain: "leite-certo-e92dd.firebaseapp.com",
    projectId: "leite-certo-e92dd",
    storageBucket: "leite-certo-e92dd.firebasestorage.app",
    messagingSenderId: "375379213395",
    appId: "1:375379213395:web:e09d6815dba946471fdaa6"
  };

  const fbApp = initializeApp(firebaseConfig);
  window.auth = getAuth(fbApp);
  window.db   = getFirestore(fbApp);
  window.fbFns = { onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, sendPasswordResetEmail, collection, doc, addDoc, getDocs, updateDoc, query, where, orderBy };
  </script>
  <style>
    :root {
      --green:     #16a34a;
      --green-dk:  #14532d;
      --green-mid: #166534;
      --green-lt:  #dcfce7;
      --cream:     #fafaf7;
      --stone:     #1c1917;
      --muted:     #78716c;
      --border:    #e7e5e0;
      --white:     #ffffff;
      --red:       #dc2626;
      --red-lt:    #fee2e2;
      --gold:      #b45309;
      --gold-lt:   #fef3c7;
      --blue:      #0284c7;
      --blue-lt:   #e0f2fe;
      --purple:    #7c3aed;
      --r:         12px;
      --sh:        0 2px 16px rgba(0,0,0,.07);
      --sh-lg:     0 12px 48px rgba(0,0,0,.16);
    }
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{font-family:'DM Sans',sans-serif;background:var(--cream);color:var(--stone);min-height:100vh;overflow-x:hidden}
    h1,h2,h3{font-family:'Playfair Display',serif}

    /* LOADING */
    #loading{position:fixed;inset:0;background:linear-gradient(145deg,var(--green),var(--green-dk));display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;gap:16px;transition:opacity .4s}
    #loading .cow{font-size:80px;animation:bounce 1.2s infinite}
    #loading p{color:rgba(255,255,255,.85);font-size:15px;font-weight:600;letter-spacing:.02em}
    @keyframes spin{to{transform:rotate(360deg)}}
    @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-14px)}}

    /* AUTH */
    #authScreen{display:none;min-height:100vh;background:linear-gradient(145deg,var(--green),var(--green-dk));align-items:center;justify-content:center;padding:24px;position:relative;overflow:hidden}
    #authScreen::before{content:'';position:absolute;width:400px;height:400px;border-radius:50%;background:rgba(255,255,255,.05);top:-100px;right:-100px}
    #authScreen::after{content:'';position:absolute;width:300px;height:300px;border-radius:50%;background:rgba(255,255,255,.04);bottom:-80px;left:-80px}
    #authScreen.active{display:flex}
    .auth-card{background:var(--white);border-radius:24px;padding:40px 32px;max-width:400px;width:100%;box-shadow:var(--sh-lg);animation:slideUp .4s ease;position:relative;z-index:1}
    .auth-logo{text-align:center;margin-bottom:28px}
    .auth-logo .cow{font-size:64px;display:block;margin-bottom:10px;animation:float 3s ease-in-out infinite}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
    .auth-logo h1{font-size:30px;color:var(--stone);margin-bottom:4px}
    .auth-logo p{color:var(--muted);font-size:13px}
    .auth-tabs{display:flex;background:var(--cream);border-radius:10px;padding:4px;margin-bottom:24px;gap:4px}
    .auth-tab{flex:1;padding:9px;border:none;background:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:700;font-family:inherit;color:var(--muted);transition:all .2s}
    .auth-tab.active{background:var(--white);color:var(--green);box-shadow:0 2px 8px rgba(0,0,0,.1)}
    .forgot-link{text-align:right;margin-top:-10px;margin-bottom:16px}
    .forgot-link a{color:var(--green);font-size:13px;text-decoration:none;font-weight:600}

    /* APP */
    #app{display:none;min-height:100vh;padding-bottom:84px}
    #app.active{display:block}

    /* HEADER */
    .header{background:linear-gradient(135deg,var(--green),var(--green-dk));color:var(--white);padding:14px 20px 0;position:sticky;top:0;z-index:100;box-shadow:0 2px 20px rgba(0,0,0,.2)}
    .header-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
    .header-logo{display:flex;align-items:center;gap:10px}
    .header-logo span{font-size:26px}
    .header-logo h1{font-size:21px;color:var(--white)}
    .header-right{display:flex;align-items:center;gap:8px}
    .user-avatar{width:34px;height:34px;border-radius:50%;background:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:800;color:var(--white);border:2px solid rgba(255,255,255,.4)}
    .btn-logout{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);color:var(--white);border-radius:8px;padding:6px 12px;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .2s}
    .btn-logout:hover{background:rgba(255,255,255,.25)}
    .nav-tabs{display:flex;gap:3px;padding-bottom:0}
    .nav-tab{flex:1;padding:9px 4px 11px;background:rgba(255,255,255,.1);border:none;border-radius:10px 10px 0 0;color:rgba(255,255,255,.65);cursor:pointer;font-size:11px;font-weight:700;font-family:inherit;display:flex;flex-direction:column;align-items:center;gap:3px;transition:all .2s;border-bottom:3px solid transparent}
    .nav-tab .nav-icon{font-size:18px}
    .nav-tab.active{background:rgba(255,255,255,.22);color:var(--white);border-bottom-color:var(--white)}

    /* CONTENT */
    .content{padding:20px;max-width:640px;margin:0 auto}
    .tab-content{display:none;animation:fadeIn .3s ease}
    .tab-content.active{display:block}

    /* FORM */
    .form-group{margin-bottom:16px}
    .form-label{display:block;font-size:11px;font-weight:700;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.06em}
    .form-input{width:100%;padding:12px 14px;border:2px solid var(--border);border-radius:var(--r);font-size:15px;font-family:inherit;color:var(--stone);background:var(--white);outline:none;transition:all .2s}
    .form-input:focus{border-color:var(--green);box-shadow:0 0 0 4px var(--green-lt)}

    /* BUTTONS */
    .btn{padding:12px 20px;border:none;border-radius:var(--r);font-size:15px;font-weight:700;font-family:inherit;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;justify-content:center;gap:8px}
    .btn-primary{background:var(--green);color:var(--white);width:100%}
    .btn-primary:hover{background:var(--green-mid);transform:translateY(-1px)}
    .btn-primary:active{transform:translateY(0)}
    .btn-secondary{background:var(--cream);color:var(--stone);border:2px solid var(--border)}
    .btn-danger{background:var(--red);color:var(--white)}
    .btn-sm{padding:7px 12px;font-size:13px;border-radius:8px}
    .btn-icon{width:36px;height:36px;padding:0;border-radius:8px;font-size:15px}

    /* ALERTS */
    .alert{padding:13px 16px;border-radius:var(--r);margin-bottom:16px;font-size:14px;font-weight:600;display:none;animation:slideDown .3s ease}
    .alert.show{display:block}
    .alert-success{background:var(--green-lt);color:var(--green-dk);border:1px solid #86efac}
    .alert-error{background:var(--red-lt);color:var(--red);border:1px solid #fca5a5}
    .alert-info{background:var(--gold-lt);color:var(--gold);border:1px solid #fcd34d}

    /* TOAST */
    #toast{position:fixed;bottom:96px;left:50%;transform:translateX(-50%) translateY(16px);background:var(--stone);color:var(--white);padding:11px 20px;border-radius:99px;font-size:14px;font-weight:600;opacity:0;transition:all .3s;z-index:9000;white-space:nowrap;pointer-events:none;box-shadow:0 4px 16px rgba(0,0,0,.2)}
    #toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

    /* RECORDS */
    .records-toolbar{display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap;align-items:center}
    .search-input{flex:1 1 140px;padding:10px 14px;border:2px solid var(--border);border-radius:var(--r);font-size:14px;font-family:inherit;color:var(--stone);background:var(--white);outline:none;transition:border .2s}
    .search-input:focus{border-color:var(--green)}
    .filter-select{padding:10px 12px;border:2px solid var(--border);border-radius:var(--r);font-size:14px;font-family:inherit;color:var(--stone);background:var(--white);outline:none;cursor:pointer}
    .summary-bar{background:linear-gradient(135deg,var(--green-lt),#bbf7d0);border-radius:var(--r);padding:10px 16px;display:flex;gap:16px;font-size:13px;font-weight:700;color:var(--green-dk);margin-bottom:14px;flex-wrap:wrap;border:1px solid #86efac}
    .record-card{background:var(--white);border:2px solid var(--border);border-left:5px solid var(--green);border-radius:var(--r);padding:16px;margin-bottom:10px;display:flex;align-items:center;gap:12px;box-shadow:var(--sh);animation:slideUp .25s ease;transition:box-shadow .2s,transform .2s}
    .record-card:hover{box-shadow:0 6px 24px rgba(0,0,0,.1);transform:translateY(-1px)}
    .record-info{flex:1;min-width:0}
    .record-name{font-size:17px;font-weight:700;color:var(--stone);margin-bottom:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .record-meta{display:flex;gap:10px;flex-wrap:wrap;font-size:13px;color:var(--muted)}
    .record-meta .liters{color:var(--blue);font-weight:700}
    .record-meta .money{color:var(--gold);font-weight:700}
    .record-actions{display:flex;gap:6px;flex-shrink:0}
    .empty-state{text-align:center;padding:64px 20px;color:var(--muted)}
    .empty-icon{font-size:56px;opacity:.3;margin-bottom:16px}
    .empty-state p{font-weight:600;font-size:15px}

    /* FAB */
    .fab{position:fixed;bottom:90px;right:20px;width:58px;height:58px;border-radius:50%;background:var(--green);color:var(--white);border:none;font-size:30px;cursor:pointer;box-shadow:0 4px 20px rgba(22,163,74,.5);display:flex;align-items:center;justify-content:center;transition:all .2s;z-index:500}
    .fab:hover{transform:scale(1.1);box-shadow:0 6px 28px rgba(22,163,74,.6)}
    .fab:active{transform:scale(.95)}

    /* MODAL */
    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:flex-end;justify-content:center;z-index:800;padding:0}
    .modal-overlay.active{display:flex;animation:fadeIn .2s ease}
    .modal{background:var(--white);border-radius:24px 24px 0 0;padding:28px 24px 32px;width:100%;max-width:480px;max-height:92vh;overflow-y:auto;animation:slideUp .3s ease}
    .modal-handle{width:40px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 20px}
    .modal-title{font-size:20px;font-weight:800;color:var(--stone);margin-bottom:20px;font-family:'Playfair Display',serif}
    .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px}

    /* REPORTS */
    .period-selector{display:flex;background:var(--white);border:2px solid var(--border);border-radius:var(--r);padding:4px;margin-bottom:16px;gap:3px}
    .period-btn{flex:1;padding:9px 4px;border:none;background:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:700;font-family:inherit;color:var(--muted);transition:all .2s}
    .period-btn.active{background:var(--green);color:var(--white);box-shadow:0 2px 8px rgba(22,163,74,.35)}
    .date-nav{display:flex;align-items:center;justify-content:space-between;background:var(--white);border:2px solid var(--border);border-radius:var(--r);padding:12px 16px;margin-bottom:18px}
    .date-nav-label{font-size:15px;font-weight:700;color:var(--stone);text-align:center;flex:1}
    .date-nav-btn{width:38px;height:38px;background:var(--cream);border:2px solid var(--border);border-radius:8px;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0}
    .date-nav-btn:hover{border-color:var(--green);color:var(--green)}
    .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:18px}
    .stat-card{background:var(--white);border:2px solid var(--border);border-radius:var(--r);padding:18px 14px;text-align:center;position:relative;overflow:hidden;box-shadow:var(--sh)}
    .stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px}
    .stat-card.liters::before{background:linear-gradient(90deg,var(--blue),#0369a1)}
    .stat-card.money::before{background:linear-gradient(90deg,var(--gold),#92400e)}
    .stat-card.count::before{background:linear-gradient(90deg,var(--green),var(--green-dk))}
    .stat-card.avg::before{background:linear-gradient(90deg,var(--purple),#5b21b6)}
    .stat-icon{font-size:24px;margin-bottom:6px}
    .stat-value{font-size:20px;font-weight:900;margin-bottom:4px;font-family:'Playfair Display',serif;line-height:1.2}
    .stat-card.liters .stat-value{color:var(--blue)}
    .stat-card.money  .stat-value{color:var(--gold)}
    .stat-card.count  .stat-value{color:var(--green)}
    .stat-card.avg    .stat-value{color:var(--purple)}
    .stat-label{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.04em}
    .chart-section{background:var(--white);border:2px solid var(--border);border-radius:var(--r);padding:18px;margin-bottom:18px;box-shadow:var(--sh)}
    .chart-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .chart-title{font-size:14px;font-weight:800;color:var(--stone)}
    .chart-toggle{display:flex;background:var(--cream);border-radius:8px;padding:3px;gap:2px}
    .chart-toggle-btn{padding:5px 10px;border:none;background:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:700;font-family:inherit;color:var(--muted);transition:all .2s}
    .chart-toggle-btn.active{background:var(--white);color:var(--stone);box-shadow:0 1px 4px rgba(0,0,0,.1)}
    .chart-bars{display:flex;flex-direction:column;gap:10px}
    .chart-bar-row{display:grid;grid-template-columns:52px 1fr 72px;align-items:center;gap:10px}
    .chart-bar-label{font-size:11px;font-weight:700;color:var(--muted);text-align:right}
    .chart-bar-track{background:var(--cream);border-radius:4px;height:10px;overflow:hidden}
    .chart-bar-fill{height:100%;border-radius:4px;transition:width .6s ease}
    .bar-liters{background:linear-gradient(90deg,var(--blue),#0369a1)}
    .bar-money{background:linear-gradient(90deg,var(--gold),#92400e)}
    .chart-bar-value{font-size:11px;font-weight:700;color:var(--stone)}
    .no-chart{padding:20px;text-align:center;color:var(--muted);font-size:14px;font-weight:600}
    .ranking-section{background:var(--white);border:2px solid var(--border);border-radius:var(--r);overflow:hidden;margin-bottom:20px;box-shadow:var(--sh)}
    .ranking-header{padding:14px 20px;border-bottom:2px solid var(--border);font-size:14px;font-weight:800;color:var(--stone)}
    .ranking-item{display:flex;align-items:center;gap:12px;padding:13px 20px;border-bottom:1px solid var(--border);transition:background .15s}
    .ranking-item:last-child{border-bottom:none}
    .ranking-item:hover{background:var(--cream)}
    .ranking-pos{font-size:22px;min-width:30px;text-align:center}
    .ranking-name{font-weight:700;color:var(--stone);font-size:15px}
    .ranking-sub{font-size:12px;color:var(--muted);margin-top:2px}
    .ranking-badge{margin-left:auto;background:var(--green-lt);color:var(--green-dk);padding:4px 10px;border-radius:99px;font-size:11px;font-weight:800;white-space:nowrap}

    /* BOT */
    .bot-wrap{display:flex;flex-direction:column;height:calc(100vh - 240px);min-height:360px}
    .bot-messages{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:12px;padding:4px 0 8px}
    .bot-msg{display:flex;align-items:flex-end;gap:8px}
    .bot-msg.user{flex-direction:row-reverse}
    .bot-avatar{width:32px;height:32px;border-radius:50%;background:var(--green);display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0}
    .bot-bubble{max-width:76%;padding:11px 14px;border-radius:16px;font-size:14px;line-height:1.65;box-shadow:0 1px 4px rgba(0,0,0,.06)}
    .bot-msg.bot  .bot-bubble{background:var(--white);color:var(--stone);border:2px solid var(--border);border-bottom-left-radius:4px}
    .bot-msg.user .bot-bubble{background:var(--green);color:var(--white);border-bottom-right-radius:4px}
    .bot-suggests{display:flex;gap:6px;flex-wrap:wrap;margin:10px 0}
    .bot-sug-btn{padding:6px 12px;background:var(--green-lt);color:var(--green-dk);border:1px solid #86efac;border-radius:99px;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .15s}
    .bot-sug-btn:hover{background:#bbf7d0}
    .bot-input-row{display:flex;gap:8px}
    .bot-input{flex:1;padding:11px 14px;border:2px solid var(--border);border-radius:var(--r);font-size:14px;font-family:inherit;color:var(--stone);background:var(--white);outline:none;transition:border .2s}
    .bot-input:focus{border-color:var(--green)}
    .btn-send{padding:11px 16px;background:var(--green);color:var(--white);border:none;border-radius:var(--r);font-size:18px;cursor:pointer;transition:all .2s;flex-shrink:0}
    .btn-send:hover{background:var(--green-mid)}

    /* ANIMATIONS */
    @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    @keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}

    /* PAGE TRANSITION */
    #pageTransition{position:fixed;bottom:0;left:0;width:100%;height:0;background:var(--green);z-index:99999;pointer-events:none;transition:height .6s cubic-bezier(.65,0,.35,1);display:flex;align-items:center;justify-content:center;overflow:hidden}
    #pageTransition.active{height:100vh}
    #pageTransition .transition-logo{opacity:0;transform:scale(.5);transition:all .4s ease .3s;font-size:64px}
    #pageTransition.active .transition-logo{opacity:1;transform:scale(1)}

    /* OFFLINE BANNER */
    #offlineBanner{position:fixed;top:0;left:0;right:0;background:var(--red);color:#fff;text-align:center;font-size:13px;font-weight:700;padding:8px;z-index:9998;transform:translateY(-100%);transition:transform .3s ease}
    #offlineBanner.show{transform:translateY(0)}

    /* RIPPLE EFFECT */
    .btn,.fab,.nav-tab,.auth-tab{position:relative;overflow:hidden}
    .btn::after,.fab::after,.nav-tab::after,.auth-tab::after{content:"";position:absolute;top:50%;left:50%;width:0;height:0;background:rgba(255,255,255,.25);border-radius:50%;transform:translate(-50%,-50%);transition:width .3s ease-out,height .3s ease-out,opacity .5s ease-out;opacity:0}
    .btn:active::after,.fab:active::after,.nav-tab:active::after,.auth-tab:active::after{width:200px;height:200px;opacity:1;transition:0s}

    /* TAB TRANSITION */
    .tab-content.active{display:block;animation:tabFadeScale .35s cubic-bezier(.2,.8,.2,1) forwards}
    @keyframes tabFadeScale{from{opacity:0;transform:scale(.97) translateY(8px)}to{opacity:1;transform:scale(1) translateY(0)}}

    /* TYPING INDICATOR */
    .typing-indicator{display:flex;gap:4px;padding:4px 2px}
    .typing-dot{width:6px;height:6px;background:var(--muted);border-radius:50%;animation:typingBounce 1s infinite}
    .typing-dot:nth-child(2){animation-delay:.2s}
    .typing-dot:nth-child(3){animation-delay:.4s}
    @keyframes typingBounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}

    /* TOAST CHECKMARK */
    .toast-inner{display:flex;align-items:center;gap:8px}
    .check-svg{width:20px;height:20px;flex-shrink:0}
    .check-circle{stroke-dasharray:166;stroke-dashoffset:166;animation:drawStroke .5s cubic-bezier(.65,0,.45,1) forwards}
    .check-path{stroke-dasharray:48;stroke-dashoffset:48;animation:drawStroke .3s cubic-bezier(.65,0,.45,1) .5s forwards}
    @keyframes drawStroke{100%{stroke-dashoffset:0}}

    /* BTN SPINNER */
    .btn-spinner-svg{display:none;width:18px;height:18px;vertical-align:middle;margin-right:6px;animation:spin .8s linear infinite}
    .btn.loading .btn-spinner-svg{display:inline-block}
    .btn.loading .btn-text{display:none}
    ::-webkit-scrollbar{width:4px}
    ::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
  </style>
</head>
<body>

<!-- LOADING -->
<div id="pageTransition"><div class="transition-logo">üêÑ</div></div>
<div id="offlineBanner">üìµ Voc√™ est√° offline. Verifique a conex√£o.</div>

<div id="loading">
  <svg width="80" height="80" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
    <path d="M50,15 C50,15 25,55 25,70 A25,25 0 0,0 75,70 C75,55 50,15 50,15 Z" fill="#ffffff">
      <animateTransform attributeName="transform" type="translate" values="0,0; 0,-15; 0,0" dur="1.2s" repeatCount="indefinite"/>
      <animate attributeName="opacity" values="1;0.8;1" dur="1.2s" repeatCount="indefinite"/>
    </path>
    <ellipse cx="50" cy="92" rx="20" ry="4" fill="#000000" opacity="0.15">
      <animate attributeName="rx" values="20;12;20" dur="1.2s" repeatCount="indefinite"/>
      <animate attributeName="opacity" values="0.15;0.05;0.15" dur="1.2s" repeatCount="indefinite"/>
    </ellipse>
  </svg>
  <p>Carregando Leite Certo‚Ä¶</p>
</div>

<!-- AUTH -->
<div id="authScreen">
  <div class="auth-card">
    <div class="auth-logo">
      <span class="cow">üêÑ</span>
      <h1>Leite Certo</h1>
      <p>Gerenciador de Entregas de Leite</p>
    </div>
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchAuth('login')">Entrar</button>
      <button class="auth-tab" onclick="switchAuth('signup')">Criar conta</button>
    </div>
    <div id="authAlert" class="alert"></div>

    <!-- LOGIN -->
    <div id="loginForm">
      <div class="form-group">
        <label class="form-label">E-mail</label>
        <input type="email" id="loginEmail" class="form-input" placeholder="seu@email.com" onkeydown="if(event.key==='Enter')doLogin()"/>
      </div>
      <div class="form-group">
        <label class="form-label">Senha</label>
        <input type="password" id="loginPass" class="form-input" placeholder="Sua senha" onkeydown="if(event.key==='Enter')doLogin()"/>
      </div>
      <div class="forgot-link"><a href="#" onclick="switchAuth('forgot');return false">Esqueci minha senha</a></div>
      <button class="btn btn-primary" id="btnLoginSubmit" onclick="doLogin()">
  <svg class="btn-spinner-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="40" fill="none" stroke="rgba(255,255,255,.3)" stroke-width="10"/><circle cx="50" cy="50" r="40" fill="none" stroke="#fff" stroke-width="10" stroke-dasharray="200" stroke-dashoffset="50" stroke-linecap="round"/></svg>
  <span class="btn-text">Entrar ‚Üí</span>
</button>
    </div>

    <!-- SIGNUP -->
    <div id="signupForm" style="display:none">
      <div class="form-group">
        <label class="form-label">Seu nome *</label>
        <input type="text" id="signupName" class="form-input" placeholder="Como voc√™ se chama" maxlength="100"/>
      </div>
      <div class="form-group">
        <label class="form-label">Telefone (opcional)</label>
        <input type="tel" id="signupPhone" class="form-input" placeholder="(00) 00000-0000" maxlength="20"/>
      </div>
      <div class="form-group">
        <label class="form-label">E-mail *</label>
        <input type="email" id="signupEmail" class="form-input" placeholder="seu@email.com"/>
      </div>
      <div class="form-group">
        <label class="form-label">Senha *</label>
        <input type="password" id="signupPass" class="form-input" placeholder="M√≠nimo 6 caracteres"/>
      </div>
      <div class="form-group">
        <label class="form-label">Confirmar senha *</label>
        <input type="password" id="signupConfirm" class="form-input" placeholder="Repita a senha"/>
      </div>
      <button class="btn btn-primary" onclick="doSignup()">Criar conta ‚Üí</button>
    </div>

    <!-- FORGOT -->
    <div id="forgotForm" style="display:none">
      <p style="color:var(--muted);font-size:14px;margin-bottom:16px;line-height:1.6">Digite seu e-mail e enviaremos um link para voc√™ criar uma nova senha.</p>
      <div class="form-group">
        <label class="form-label">E-mail</label>
        <input type="email" id="forgotEmail" class="form-input" placeholder="seu@email.com"/>
      </div>
      <button class="btn btn-primary" onclick="doForgot()">Enviar link ‚Üí</button>
      <button class="btn btn-secondary" style="width:100%;margin-top:10px" onclick="switchAuth('login')">‚Üê Voltar</button>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div class="header">
    <div class="header-top">
      <div class="header-logo">
        <span>üêÑ</span>
        <h1>Leite Certo</h1>
      </div>
      <div class="header-right">
        <div class="user-avatar" id="userAvatar">?</div>
        <button class="btn-logout" onclick="doLogout()">Sair</button>
      </div>
    </div>
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="switchTab('registros')">
        <span class="nav-icon">üìã</span>Registros
      </button>
      <button class="nav-tab" onclick="switchTab('relatorios')">
        <span class="nav-icon">üìä</span>Relat√≥rios
      </button>
      <button class="nav-tab" onclick="switchTab('bot')">
        <span class="nav-icon">üí¨</span>Assistente
      </button>
    </div>
  </div>

  <div class="content">
    <div id="appAlert" class="alert"></div>

    <!-- REGISTROS -->
    <div id="tab-registros" class="tab-content active">
      <div class="records-toolbar">
        <input class="search-input" placeholder="üîç Buscar por nome‚Ä¶" id="searchInput" oninput="renderRecords()"/>
        <select class="filter-select" id="monthFilter" onchange="renderRecords()">
          <option value="">Todos os meses</option>
        </select>
      </div>
      <div id="summaryBar" class="summary-bar" style="display:none"></div>
      <div id="recordsList"></div>
    </div>

    <!-- RELATORIOS -->
    <div id="tab-relatorios" class="tab-content">
      <div class="period-selector">
        <button class="period-btn active" onclick="setPeriod('dia')">Dia</button>
        <button class="period-btn" onclick="setPeriod('semana')">Semana</button>
        <button class="period-btn" onclick="setPeriod('mes')">M√™s</button>
        <button class="period-btn" onclick="setPeriod('ano')">Ano</button>
      </div>
      <div class="date-nav">
        <button class="date-nav-btn" onclick="navDate(-1)">‚Äπ</button>
        <span class="date-nav-label" id="dateLabel">‚Äî</span>
        <button class="date-nav-btn" onclick="navDate(1)">‚Ä∫</button>
      </div>
      <div class="stats-grid" id="reportStats"></div>
      <div class="chart-section">
        <div class="chart-header">
          <span class="chart-title" id="chartTitle">Produ√ß√£o</span>
          <div class="chart-toggle">
            <button class="chart-toggle-btn active" id="togL" onclick="setChartMode('liters')">ü•õ Litros</button>
            <button class="chart-toggle-btn" id="togM" onclick="setChartMode('money')">üí∞ Receita</button>
          </div>
        </div>
        <div class="chart-bars" id="chartBars"></div>
      </div>
      <div class="ranking-section">
        <div class="ranking-header">üèÜ Ranking de Clientes</div>
        <div id="rankingList"></div>
      </div>
    </div>

    <!-- BOT -->
    <div id="tab-bot" class="tab-content">
      <div class="bot-wrap">
        <div class="bot-messages" id="botMessages"></div>
        <div class="bot-suggests" id="botSuggests"></div>
        <div class="bot-input-row">
          <input class="bot-input" id="botInput" placeholder="Fa√ßa uma pergunta‚Ä¶" onkeydown="if(event.key==='Enter')sendBot()"/>
          <button class="btn-send" onclick="sendBot()"><svg width="22" height="22" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle"><g><animateTransform attributeName="transform" type="translate" values="0,0; 4,-4; 0,0" dur="2s" repeatCount="indefinite"/><path d="M10,50 L90,10 L50,90 L40,60 Z" fill="none" stroke="currentColor" stroke-width="8" stroke-linejoin="round"/><line x1="90" y1="10" x2="40" y2="60" stroke="currentColor" stroke-width="8"/></g></svg></button>
        </div>
      </div>
    </div>
  </div>

  <button class="fab" id="fab" onclick="openAddModal()">+</button>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modalTitle">Nova Entrega</div>
    <div class="form-group">
      <label class="form-label">Entregue para *</label>
      <input type="text" id="fPerson" class="form-input" placeholder="Nome do cliente ou mini f√°brica"/>
    </div>
    <div class="form-group">
      <label class="form-label">Quantidade em Litros *</label>
      <input type="number" id="fQty" class="form-input" placeholder="Ex: 50" min="0.1" step="0.1"/>
    </div>
    <div class="form-group">
      <label class="form-label">Pre√ßo por Litro R$ (opcional)</label>
      <input type="text" inputmode="numeric" id="fPrice" class="form-input" placeholder="Ex: 4,50"/>
    </div>
    <div class="form-group">
      <label class="form-label">Data da Entrega *</label>
      <input type="date" id="fDate" class="form-input"/>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
      <button class="btn btn-primary" style="width:auto" onclick="saveRecord()">üíæ Salvar</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
    // Wait for Firebase to load
    function waitFb(cb){
      if(window.auth && window.db && window.fbFns) cb();
      else setTimeout(()=>waitFb(cb), 50);
    }

    const SUGGESTS = ['total de litros','receita total','entregas de hoje','resumo da semana','resumo do m√™s','quem recebeu mais'];
    let records = [], editingId = null, period = 'mes', dateRef = new Date(), chartMode = 'liters', botMsgs = [];

    // BOOT
    window.addEventListener('load', () => {
      if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(()=>{});
      waitFb(() => {
        const { onAuthStateChanged } = window.fbFns;
        onAuthStateChanged(window.auth, async (user) => {
          hideLoading();
          if (user) await startApp(user);
          else showAuth();
        });
      });
    });

    function hideLoading(){
      const l = document.getElementById('loading');
      l.style.opacity = '0';
      setTimeout(() => l.style.display = 'none', 400);
    }

    async function startApp(user){
      const tr = document.getElementById('pageTransition');
      tr.classList.add('active');
      await loadRecords();
      setTimeout(() => {
        document.getElementById('authScreen').classList.remove('active');
        document.getElementById('app').classList.add('active');
        document.getElementById('userAvatar').textContent = (user.email||'?')[0].toUpperCase();
        initBot();
        updateReports();
        setTimeout(() => tr.classList.remove('active'), 400);
      }, 600);
    }

    function showAuth(){
      document.getElementById('app').classList.remove('active');
      document.getElementById('authScreen').classList.add('active');
      records = [];
    }

    // AUTH
    function switchAuth(tab){
      ['loginForm','signupForm','forgotForm'].forEach(id => document.getElementById(id).style.display = 'none');
      document.getElementById(tab === 'forgot' ? 'forgotForm' : tab === 'signup' ? 'signupForm' : 'loginForm').style.display = 'block';
      document.querySelectorAll('.auth-tab').forEach((b,i) => b.classList.toggle('active',(i===0&&tab==='login')||(i===1&&tab==='signup')));
      document.getElementById('authAlert').className = 'alert';
    }

    async function doLogin(){
      const email = document.getElementById('loginEmail').value.trim();
      const pass  = document.getElementById('loginPass').value;
      if (!email||!pass){ showAuthAlert('Preencha e-mail e senha.','error'); return; }
      const btn = document.getElementById('btnLoginSubmit');
      if(btn) btn.classList.add('loading');
      try {
        const { signInWithEmailAndPassword } = window.fbFns;
        await signInWithEmailAndPassword(window.auth, email, pass);
      } catch(e) {
        if(btn) btn.classList.remove('loading');
        const msg = e.code === 'auth/invalid-credential' || e.code === 'auth/wrong-password' || e.code === 'auth/user-not-found'
          ? 'E-mail ou senha incorretos.'
          : 'Erro ao conectar. Tente novamente.';
        showAuthAlert(msg,'error');
      }
    }

    async function doSignup(){
      const name    = document.getElementById('signupName').value.trim().substring(0,100);
      const email   = document.getElementById('signupEmail').value.trim().substring(0,150);
      const pass    = document.getElementById('signupPass').value;
      const confirm = document.getElementById('signupConfirm').value;
      if (!name){ showAuthAlert('Digite seu nome.','error'); return; }
      if (!email||!pass){ showAuthAlert('Preencha todos os campos.','error'); return; }
      if (pass.length < 6){ showAuthAlert('Senha m√≠nimo 6 caracteres.','error'); return; }
      if (pass !== confirm){ showAuthAlert('As senhas n√£o coincidem.','error'); return; }
      try {
        const { createUserWithEmailAndPassword, collection, addDoc } = window.fbFns;
        const cred = await createUserWithEmailAndPassword(window.auth, email, pass);
        await addDoc(collection(window.db, 'profiles'), {
          uid: cred.user.uid, name, email, created_at: new Date().toISOString()
        });
        showAuthAlert('Conta criada! Entrando‚Ä¶','success');
      } catch(e) {
        showAuthAlert('N√£o foi poss√≠vel criar a conta. Tente outro e-mail.','error');
      }
    }

    async function doForgot(){
      const email = document.getElementById('forgotEmail').value.trim();
      if (!email){ showAuthAlert('Digite seu e-mail.','error'); return; }
      try {
        const { sendPasswordResetEmail } = window.fbFns;
        await sendPasswordResetEmail(window.auth, email);
        showAuthAlert('E-mail enviado! Verifique sua caixa de entrada.','success');
      } catch(e) {
        showAuthAlert('N√£o foi poss√≠vel enviar. Verifique o e-mail.','error');
      }
    }

    async function doLogout(){
      if (!confirm('Sair do app?')) return;
      const { signOut } = window.fbFns;
      await signOut(window.auth);
    }

    function showAuthAlert(msg,type){
      const el = document.getElementById('authAlert');
      el.textContent = msg;
      el.className = `alert alert-${type} show`;
    }

    // RECORDS
    async function loadRecords(){
      const user = window.auth.currentUser;
      if (!user) return;
      const { collection, query, where, orderBy, getDocs } = window.fbFns;
      try {
        const q = query(
          collection(window.db, 'entregas'),
          where('user_id', '==', user.uid),
          where('deleted_at', '==', null),
          orderBy('date', 'desc')
        );
        const snap = await getDocs(q);
        records = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch(e) { records = []; }
      renderRecords();
      populateMonthFilter();
    }

    async function saveRecord(){
      const person = document.getElementById('fPerson').value.trim().substring(0,100);
      const qty    = parseFloat(document.getElementById('fQty').value);
      const rawPrice = document.getElementById('fPrice').value.replace(',','.');
      const price  = parseFloat(rawPrice) || 0;
      const date   = document.getElementById('fDate').value;
      if (!person||!qty||!date){ toast('‚ö†Ô∏è Preencha os campos obrigat√≥rios!'); return; }
      if (qty <= 0){ toast('‚ö†Ô∏è Quantidade deve ser maior que zero.'); return; }
      const saveBtn = document.querySelector('.modal-actions .btn-primary');
      if(saveBtn){ saveBtn.disabled=true; saveBtn.innerHTML='Salvando‚Ä¶'; }
      try {
        const user = window.auth.currentUser;
        if (!user){ toast('‚ö†Ô∏è Sess√£o expirada. Fa√ßa login novamente.'); return; }
        const { collection, doc, addDoc, updateDoc } = window.fbFns;
        if (editingId){
          await updateDoc(doc(window.db, 'entregas', editingId), { person, quantity:qty, price, date });
          toast('Registro atualizado! ‚úÖ','success');
        } else {
          await addDoc(collection(window.db, 'entregas'), {
            user_id: user.uid, person, quantity: qty, price, date, deleted_at: null, created_at: new Date().toISOString()
          });
          toast('Entrega registrada! üéâ','success');
        }
        if(saveBtn){saveBtn.disabled=false;saveBtn.innerHTML='üíæ Salvar';}
        closeModal();
        await loadRecords();
        updateReports();
      } catch(e) {
        toast('‚ö†Ô∏è Erro ao salvar. Tente novamente.');
        if(saveBtn){saveBtn.disabled=false;saveBtn.innerHTML='üíæ Salvar';}
      }
    }

    async function deleteRecord(id){
      if (!confirm('Apagar este registro?')) return;
      records = records.filter(r => r.id !== id);
      renderRecords();
      updateReports();
      toast('Registro apagado.');
      try {
        const { doc, updateDoc } = window.fbFns;
        await updateDoc(doc(window.db, 'entregas', id), { deleted_at: new Date().toISOString() });
      } catch(e) {}
    }

    // RENDER RECORDS
    function renderRecords(){
      const search = (document.getElementById('searchInput')?.value||'').toLowerCase();
      const month  = document.getElementById('monthFilter')?.value||'';
      const list   = records.filter(r => r.person.toLowerCase().includes(search) && (month ? r.date.startsWith(month) : true));
      const tL     = list.reduce((s,r)=>s+r.quantity,0);
      const tR     = list.reduce((s,r)=>s+r.quantity*(r.price||0),0);
      const bar    = document.getElementById('summaryBar');
      if (list.length > 0){
        bar.style.display = 'flex';
        bar.innerHTML = `<span>üì¶ ${list.length} entrega${list.length!==1?'s':''}</span><span>ü•õ ${fL(tL)}</span>${tR>0?`<span>üí∞ ${fR(tR)}</span>`:''}`;
      } else { bar.style.display = 'none'; }
      const el = document.getElementById('recordsList');
      if (list.length === 0){
        el.innerHTML = `<div class="empty-state"><div class="empty-icon">ü•õ</div><p>${search||month?'Nenhum resultado.':'Nenhum registro ainda. Toque no + para adicionar!'}</p></div>`;
        return;
      }
      el.innerHTML = list.map(r => `
        <div class="record-card" data-id="${r.id}">
          <div class="record-info">
            <div class="record-name">${esc(r.person)}</div>
            <div class="record-meta">
              <span class="liters">ü•õ ${fL(r.quantity)}</span>
              <span>üìÖ ${fDate(r.date)}</span>
              ${r.price>0?`<span class="money">üí∞ ${fR(r.quantity*r.price)}</span>`:''}
            </div>
          </div>
          <div class="record-actions">
            <button class="btn btn-secondary btn-sm btn-icon" onclick="openEditModal('${r.id}')">‚úèÔ∏è</button>
            <button class="btn btn-danger btn-sm btn-icon" onclick="deleteRecord('${r.id}')">üóëÔ∏è</button>
          </div>
        </div>`).join('');
    }

    function populateMonthFilter(){
      const months = [...new Set(records.map(r=>r.date.slice(0,7)))].sort().reverse();
      const sel = document.getElementById('monthFilter');
      const cur = sel.value;
      sel.innerHTML = '<option value="">Todos os meses</option>' +
        months.map(m=>`<option value="${m}"${m===cur?' selected':''}>${fMonth(m)}</option>`).join('');
    }

    // MODAL
    function openAddModal(){
      editingId = null;
      document.getElementById('modalTitle').textContent = '‚ûï Nova Entrega';
      document.getElementById('fPerson').value = '';
      document.getElementById('fQty').value    = '';
      document.getElementById('fPrice').value  = '';
      document.getElementById('fDate').value   = todayStr();
      document.getElementById('modalOverlay').classList.add('active');
    }

    function openEditModal(id){
      const r = records.find(r=>r.id===id);
      if (!r) return;
      editingId = id;
      document.getElementById('modalTitle').textContent = '‚úèÔ∏è Editar Entrega';
      document.getElementById('fPerson').value = r.person;
      document.getElementById('fQty').value    = r.quantity;
      document.getElementById('fPrice').value  = r.price||'';
      document.getElementById('fDate').value   = r.date;
      document.getElementById('modalOverlay').classList.add('active');
    }

    function closeModal(){
      document.getElementById('modalOverlay').classList.remove('active');
      editingId = null;
    }

    // TABS
    function switchTab(name){
      document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));
      document.querySelectorAll('.nav-tab').forEach(el=>el.classList.remove('active'));
      document.getElementById(`tab-${name}`).classList.add('active');
      document.querySelectorAll('.nav-tab')[['registros','relatorios','bot'].indexOf(name)].classList.add('active');
      document.getElementById('fab').style.display = name==='bot'?'none':'flex';
      if (name==='relatorios') updateReports();
    }

    // REPORTS
    function setPeriod(p){ period=p; dateRef=new Date(); document.querySelectorAll('.period-btn').forEach((b,i)=>b.classList.toggle('active',['dia','semana','mes','ano'][i]===p)); updateReports(); }
    function navDate(dir){ if(period==='dia') dateRef.setDate(dateRef.getDate()+dir); else if(period==='semana') dateRef.setDate(dateRef.getDate()+dir*7); else if(period==='mes') dateRef.setMonth(dateRef.getMonth()+dir); else dateRef.setFullYear(dateRef.getFullYear()+dir); updateReports(); }
    function setChartMode(m){ chartMode=m; document.getElementById('togL').classList.toggle('active',m==='liters'); document.getElementById('togM').classList.toggle('active',m==='money'); updateReports(); }

    function updateReports(){
      const{filtered,label,bars,ranking}=getReportData();
      document.getElementById('dateLabel').textContent=label;
      const tL=filtered.reduce((s,r)=>s+r.quantity,0),tR=filtered.reduce((s,r)=>s+r.quantity*(r.price||0),0),cnt=filtered.length,avg=cnt?tL/cnt:0;
      document.getElementById('reportStats').innerHTML=`<div class="stat-card liters"><div class="stat-icon">ü•õ</div><div class="stat-value">${fL(tL)}</div><div class="stat-label">Litros entregues</div></div><div class="stat-card money"><div class="stat-icon">üí∞</div><div class="stat-value">${fR(tR)}</div><div class="stat-label">Dinheiro ganho</div></div><div class="stat-card count"><div class="stat-icon">üì¶</div><div class="stat-value">${cnt}</div><div class="stat-label">Entregas</div></div><div class="stat-card avg"><div class="stat-icon">üìà</div><div class="stat-value">${fL(avg)}</div><div class="stat-label">M√©dia / entrega</div></div>`;
      const maxV=Math.max(...bars.map(b=>chartMode==='liters'?b.liters:b.money),1);
      document.getElementById('chartTitle').textContent=chartMode==='liters'?'ü•õ Litros por per√≠odo':'üí∞ Receita por per√≠odo';
      document.getElementById('chartBars').innerHTML=bars.length===0?'<div class="no-chart">Sem dados</div>':bars.map(b=>{const val=chartMode==='liters'?b.liters:b.money;return`<div class="chart-bar-row"><span class="chart-bar-label">${b.label}</span><div class="chart-bar-track"><div class="chart-bar-fill ${chartMode==='liters'?'bar-liters':'bar-money'}" style="width:${(val/maxV*100).toFixed(1)}%"></div></div><span class="chart-bar-value">${chartMode==='liters'?fL(val):fR(val)}</span></div>`;}).join('');
      document.getElementById('rankingList').innerHTML=ranking.length===0?'<div style="padding:20px;text-align:center;color:var(--muted)">Nenhum dado</div>':ranking.map(([name,s],i)=>`<div class="ranking-item"><span class="ranking-pos">${['ü•á','ü•à','ü•â'][i]||`#${i+1}`}</span><div><div class="ranking-name">${esc(name)}</div><div class="ranking-sub">${fL(s.liters)} ‚Ä¢ ${s.count} entrega${s.count!==1?'s':''}${s.money>0?` ‚Ä¢ ${fR(s.money)}`:''}</div></div><span class="ranking-badge">${fL(s.liters)}</span></div>`).join('');
    }

    function getReportData(){
      const d=new Date(dateRef); let filtered=[],label='',bars=[];
      if(period==='dia'){const str=toStr(d);filtered=records.filter(r=>r.date===str);label=fDate(str);const tL=filtered.reduce((s,r)=>s+r.quantity,0),tM=filtered.reduce((s,r)=>s+r.quantity*(r.price||0),0);bars=[{label:'Hoje',liters:tL,money:tM}];}
      else if(period==='semana'){const start=new Date(d);start.setDate(d.getDate()-d.getDay());const end=new Date(start);end.setDate(start.getDate()+6);filtered=records.filter(r=>r.date>=toStr(start)&&r.date<=toStr(end));label=`${fDate(toStr(start))} ‚Äì ${fDate(toStr(end))}`;bars=['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'].map((lbl,i)=>{const ds=new Date(start);ds.setDate(start.getDate()+i);const str=toStr(ds);const recs=records.filter(r=>r.date===str);return{label:lbl,liters:recs.reduce((s,r)=>s+r.quantity,0),money:recs.reduce((s,r)=>s+r.quantity*(r.price||0),0)};});}
      else if(period==='mes'){const ym=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;filtered=records.filter(r=>r.date.startsWith(ym));label=fMonth(ym);const dim=new Date(d.getFullYear(),d.getMonth()+1,0).getDate();bars=Array.from({length:dim},(_,i)=>{const day=String(i+1).padStart(2,'0'),str=`${ym}-${day}`;const recs=records.filter(r=>r.date===str);return{label:String(i+1),liters:recs.reduce((s,r)=>s+r.quantity,0),money:recs.reduce((s,r)=>s+r.quantity*(r.price||0),0)};}).filter(b=>b.liters>0||b.money>0);}
      else{const y=d.getFullYear();filtered=records.filter(r=>r.date.startsWith(String(y)));label=String(y);bars=['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'].map((lbl,i)=>{const m=String(i+1).padStart(2,'0');const recs=records.filter(r=>r.date.startsWith(`${y}-${m}`));return{label:lbl,liters:recs.reduce((s,r)=>s+r.quantity,0),money:recs.reduce((s,r)=>s+r.quantity*(r.price||0),0)};});}
      const byP={};filtered.forEach(r=>{if(!byP[r.person])byP[r.person]={liters:0,money:0,count:0};byP[r.person].liters+=r.quantity;byP[r.person].money+=r.quantity*(r.price||0);byP[r.person].count+=1;});
      return{filtered,label,bars,ranking:Object.entries(byP).sort((a,b)=>b[1].liters-a[1].liters)};
    }

    // BOT
    function initBot(){
      botMsgs=[];
      addMsg('bot','Ol√°! üëã Sou o assistente do *Leite Certo*.\n\nPergunte sobre as entregas!\n\nOu digite *ajuda* para ver o que sei responder.');
      const botSugEl=document.getElementById('botSuggests');
      botSugEl.innerHTML='';
      SUGGESTS.forEach(s=>{const btn=document.createElement('button');btn.className='bot-sug-btn';btn.textContent=s;btn.addEventListener('click',()=>sendBot(s));botSugEl.appendChild(btn);});
    }

    function sendBot(text){
      const input=document.getElementById('botInput');
      const q=text||input.value.trim();
      if(!q)return;
      input.value='';
      addMsg('user',q);
      setTimeout(()=>addMsg('bot',botReply(q)),700);
    }

    function addMsg(from,text){
      botMsgs.push({from,text});
      const el=document.getElementById('botMessages');
      el.innerHTML=botMsgs.map(m=>`<div class="bot-msg ${m.from}">${m.from==='bot'?'<div class="bot-avatar">üêÑ</div>':''}<div class="bot-bubble">${renderText(m.text)}</div></div>`).join('');
      el.scrollTop=el.scrollHeight;
    }

    function renderText(t){ return t.replace(/\*([^*]+)\*/g,'<strong>$1</strong>').replace(/
/g,'<br>'); }

    function botReply(msg){
      const m=msg.toLowerCase().trim();
      const tL=records.reduce((s,r)=>s+r.quantity,0),tR=records.reduce((s,r)=>s+r.quantity*(r.price||0),0),cnt=records.length;
      const td=todayStr(),todayR=records.filter(r=>r.date===td);
      const ym=td.slice(0,7),monthR=records.filter(r=>r.date.startsWith(ym));
      const byP={};records.forEach(r=>{if(!byP[r.person])byP[r.person]=0;byP[r.person]+=r.quantity;});
      const rank=Object.entries(byP).sort((a,b)=>b[1]-a[1]);
      if(/^(oi|ol√°|ola|bom dia|boa tarde|boa noite)/.test(m))return'Ol√°! üëã Digite *ajuda* para ver o que sei responder!';
      if(m.includes('ajuda'))return'Posso responder:\n\nü•õ *"total de litros"*\nüí∞ *"receita total"*\nüìÖ *"entregas de hoje"*\nüìÜ *"resumo do m√™s"*\nüèÜ *"quem recebeu mais"*';
      if((m.includes('total')||m.includes('quanto'))&&m.includes('litro'))return cnt===0?'Sem registros ainda. üì≠':`ü•õ Total: *${fL(tL)}* em *${cnt}* entrega${cnt!==1?'s':''}${tR>0?`\nüí∞ Receita: *${fR(tR)}*`:''}`;
      if(m.includes('receita')||m.includes('dinheiro'))return tR>0?`üí∞ Receita total: *${fR(tR)}*\nü•õ Referente a *${fL(tL)}* litros.`:'Nenhum pre√ßo cadastrado ainda.';
      if(m.includes('hoje'))return todayR.length===0?'Nenhuma entrega hoje. üì≠':`üìÖ Hoje: ü•õ *${fL(todayR.reduce((s,r)=>s+r.quantity,0))}* em *${todayR.length}* entrega${todayR.length!==1?'s':''}`;
      if(m.includes('m√™s')||m.includes('mes'))return monthR.length===0?'Sem entregas este m√™s.':`üìÜ ${fMonth(ym)}: ü•õ *${fL(monthR.reduce((s,r)=>s+r.quantity,0))}* em *${monthR.length}* entrega${monthR.length!==1?'s':''}${monthR.reduce((s,r)=>s+r.quantity*(r.price||0),0)>0?`\nüí∞ ${fR(monthR.reduce((s,r)=>s+r.quantity*(r.price||0),0))}`:''}`;
      if(m.includes('recebeu mais')||m.includes('ranking'))return rank.length===0?'Sem dados.':`üèÜ Top:\n\n${rank.slice(0,3).map(([n,l],i)=>`${['ü•á','ü•à','ü•â'][i]} *${n}*: ${fL(l)}`).join('\n')}`;
      if(m.includes('obrigad')||m.includes('valeu'))return'De nada! üòä';
      return'N√£o entendi. ü§î Digite *ajuda*!';
    }

    // UTILS
    document.addEventListener('DOMContentLoaded',()=>{
      const fPriceEl=document.getElementById('fPrice');
      if(fPriceEl)fPriceEl.addEventListener('input',function(e){let v=e.target.value.replace(/\D/g,'');if(v===''){e.target.value='';return;}e.target.value=(parseInt(v,10)/100).toFixed(2).replace('.',',');});
    });
    window.addEventListener('online',()=>document.getElementById('offlineBanner').classList.remove('show'));
    window.addEventListener('offline',()=>document.getElementById('offlineBanner').classList.add('show'));

    const fL=n=>n.toLocaleString('pt-BR',{minimumFractionDigits:1,maximumFractionDigits:1})+' L';
    const fR=n=>'R$ '+n.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
    const todayStr=()=>new Date().toISOString().split('T')[0];
    const toStr=d=>d.toISOString().split('T')[0];
    const esc=t=>{const d=document.createElement('div');d.textContent=t;return d.innerHTML;};
    const fDate=s=>new Date(s+'T00:00:00').toLocaleDateString('pt-BR');
    const fMonth=ym=>new Date(ym+'-01').toLocaleDateString('pt-BR',{month:'long',year:'numeric'});

    function toast(msg,type='default'){
      const el=document.getElementById('toast');
      el.textContent=msg;
      el.style.background=type==='success'?'var(--green)':'var(--stone)';
      el.classList.add('show');
      setTimeout(()=>el.classList.remove('show'),2800);
    }
  </script>
</body>
</html>
